# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®åå‰
name: Test v2 Release (with Retry)

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã‚‹ãƒˆãƒªã‚¬ãƒ¼
on:
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã®ã¿

# å®Ÿè¡Œã•ã‚Œã‚‹ã‚¸ãƒ§ãƒ–ã‚’å®šç¾©
jobs:
  v2-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # 2. ãƒ–ãƒ©ãƒ³ãƒã€Œ2ã€ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
      - name: Check if branch 2 exists
        run: |
          if ! git show-ref --verify --quiet refs/remotes/origin/2; then
            echo "Error: Branch '2' does not exist. Please create v2 release first."
            exit 1
          fi
          echo "Branch '2' exists. Proceeding with tests."

      # 3. Laravel Duskãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆæœ€å¤§10å›ãƒªãƒˆãƒ©ã‚¤ï¼‰
      - name: Run Laravel Dusk Tests with Retry
        run: |
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "=========================================="
            echo "Laravel Dusk Test attempt $attempt of $max_attempts"
            echo "=========================================="
            
            # Laravel Duskãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œï¼ˆPHP 8.1æŒ‡å®šã€ãƒ–ãƒ©ãƒ³ãƒ2ï¼‰
            if gh workflow run "Laravel Dusk Connect-cms-test" --ref 2 -f php_version=8.1; then
              echo "âœ“ Triggered Laravel Dusk test workflow (attempt $attempt)"
              echo "  - Branch: 2"
              echo "  - PHP Version: 8.1"
              
              # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Œäº†ã‚’å¾…æ©Ÿ
              echo "Waiting 30 seconds for workflow to start..."
              sleep 30
              
              # æœ€æ–°ã®å®Ÿè¡Œçµæœã‚’ç¢ºèª
              run_id=$(gh run list --workflow="Laravel Dusk Connect-cms-test" --branch=2 --limit=1 --json databaseId --jq '.[0].databaseId')
              
              if [ -z "$run_id" ] || [ "$run_id" = "null" ]; then
                echo "âŒ Failed to get workflow run ID"
                if [ $attempt -eq $max_attempts ]; then
                  echo "All $max_attempts attempts failed. Could not get workflow run ID."
                  exit 1
                fi
              else
                echo "Workflow run ID: $run_id"
                
                # å®Ÿè¡Œå®Œäº†ã¾ã§å¾…æ©Ÿ
                echo "Waiting for test completion..."
                while true; do
                  status=$(gh run view $run_id --json status --jq '.status')
                  conclusion=$(gh run view $run_id --json conclusion --jq '.conclusion')
                  
                  echo "  Status: $status, Conclusion: $conclusion"
                  
                  if [ "$status" = "completed" ]; then
                    break
                  fi
                  
                  echo "  Still running... waiting 30 seconds"
                  sleep 30
                done
                
                # å®Ÿè¡Œçµæœã‚’ç¢ºèª
                echo "=========================================="
                echo "Test Results for attempt $attempt:"
                echo "  Status: $status"
                echo "  Conclusion: $conclusion"
                echo "=========================================="
                
                if [ "$conclusion" = "success" ]; then
                  echo "ğŸ‰ Laravel Dusk tests PASSED on attempt $attempt!"
                  echo ""
                  echo "âœ… v2 testing completed successfully!"
                  echo "   You can now proceed with confidence that the v2 release is working correctly."
                  exit 0
                else
                  echo "âŒ Laravel Dusk tests FAILED on attempt $attempt"
                  echo "   Conclusion: $conclusion"
                  
                  if [ $attempt -eq $max_attempts ]; then
                    echo ""
                    echo "ğŸ’¥ All $max_attempts test attempts failed!"
                    echo "   Please check the test logs and fix issues before retrying."
                    echo "   You can run this workflow again after fixing the problems."
                    exit 1
                  fi
                fi
              fi
            else
              echo "âŒ Failed to trigger Laravel Dusk test workflow on attempt $attempt"
              if [ $attempt -eq $max_attempts ]; then
                echo "Failed to trigger tests after $max_attempts attempts."
                exit 1
              fi
            fi
            
            attempt=$((attempt + 1))
            echo ""
            echo "â³ Waiting 60 seconds before next attempt..."
            echo "   Attempt $attempt of $max_attempts will start soon..."
            sleep 60
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 4. æˆåŠŸæ™‚ã®å¾Œå‡¦ç†ï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼‰
      - name: Test Success Notification
        if: success()
        run: |
          echo "ğŸ‰ All v2 tests completed successfully!"
          echo "The v2 release is ready for production use."