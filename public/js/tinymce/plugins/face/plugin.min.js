tinymce.PluginManager.add('face', function(editor, url) {
    // アイコン
    editor.ui.registry.addIcon('face', '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" width="24" height="24"><!-- Font Awesome Pro 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) --><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 448c-110.3 0-200-89.7-200-200S137.7 56 248 56s200 89.7 200 200-89.7 200-200 200zm105.6-151.4c-25.9 8.3-64.4 13.1-105.6 13.1s-79.6-4.8-105.6-13.1c-9.8-3.1-19.4 5.3-17.7 15.3 7.9 47.2 71.3 80 123.3 80s115.3-32.9 123.3-80c1.6-9.8-7.7-18.4-17.7-15.3zm-227.9-57.5c-1 6.2 5.4 11 11 7.9l31.3-16.3 31.3 16.3c5.6 3.1 12-1.7 11-7.9l-6-34.9 25.4-24.6c4.5-4.5 1.9-12.2-4.3-13.2l-34.9-5-15.5-31.6c-2.9-5.8-11-5.8-13.9 0l-15.5 31.6-34.9 5c-6.2.9-8.9 8.6-4.3 13.2l25.4 24.6-6.1 34.9zm259.7-72.7l-34.9-5-15.5-31.6c-2.9-5.8-11-5.8-13.9 0l-15.5 31.6-34.9 5c-6.2.9-8.9 8.6-4.3 13.2l25.4 24.6-6 34.9c-1 6.2 5.4 11 11 7.9l31.3-16.3 31.3 16.3c5.6 3.1 12-1.7 11-7.9l-6-34.9 25.4-24.6c4.5-4.6 1.8-12.2-4.4-13.2z"/></svg>');

    // プラグインボタンの追加
    // see) https://www.tiny.cloud/docs/advanced/creating-a-plugin/
    editor.ui.registry.addButton("face", {
        icon: "face",
        tooltip: "AI顔認識",
        onAction: pluginWin,

        onPostRender: function() { // プラグイン要素選択時プラグインボタンアクティブ
            var _this = this;
            editor.on("NodeChange", function(e) {
                var is_active = jQuery( editor.selection.getNode() ).hasClass("plugin");
                _this.active( is_active );
            })

            editor.on("DblClick", function(e) {
                if ( e.target.className == "plugin" ) {
                    pluginWin(e.toElement.innerText);
                }
            })
        },
    });

    function pluginWin(e) { // プラグインウィンドウを開く関数
        tinymce.activeEditor.windowManager.open({
            title: "AI顔認識",
            body: {
                type: 'panel',
                items: [
                    {
                        // see) https://www.tiny.cloud/docs/ui-components/dialogcomponents/#alertbanner
                        type: 'alertbanner',
                        level: 'info',
                        text: '写真の顔をAIで判断して、モザイク処理を施します。',
                        icon: 'info',
                    },
                    {
                        // see) https://www.tiny.cloud/docs/ui-components/dialogcomponents/#urlinput
                        type: "urlinput",
                        name: "photo",
                        filetype: 'file', // allow any file types
                        label: 'jpg, png 形式の画像ファイル'
                    },
                        // アップロードできる最大サイズのキャプション
                    {
                        type: 'collection',
                        name: 'upload_max_filesize_caption', // identifier
                        label: editor.settings.cc_config.upload_max_filesize_caption
                    },
                    {
                        // 代替テキスト
                        type: 'input',
                        name: 'alt',
                        inputMode: 'text',
                        label: '代替テキスト',
                        placeholder: '',
                        disabled: false,
                        maximized: false
                    },
                    {
                        type: 'listbox',
                        name: 'image_size', // identifier
                        label: '画像サイズ（最大でこの大きさに縮小されます）',
                        disabled: false,
                        items: editor.settings.cc_config.face_image_sizes
                    },
                    {
                        type: 'listbox',
                        name: 'mosaic_fineness', // identifier
                        label: 'モザイクの粗さ',
                        disabled: false,
                        items: editor.settings.cc_config.finenesses
                    }
                ]
            },
            // 初期値設定
            initialData: {
                image_size:editor.settings.cc_config.face_image_initial,
                mosaic_fineness:editor.settings.cc_config.fineness_initial
            },
            buttons: [
                {
                    type: 'cancel',
                    text: 'Close'
                },
                {
                    type: 'submit',
                    text: 'Save',
                    primary: true
                }
            ],
            // OKボタンをクリックした際の挙動
            onSubmit: function(api) {

                // AJAX
                xhr = new XMLHttpRequest();
                xhr.withCredentials = false;
                xhr.open('POST', tinymce.activeEditor.getParam('document_base_url') + '/upload/face');

                xhr.onload = function() {
                    var json;

                    if (xhr.status < 200 || xhr.status >= 300) {
                        // コンソールのエラー出力
                        console.error('HTTP Error: ' + xhr.status);
                        return;
                    }

                    // jsonエラーは、JSON.parse()で発生するため、特別処理を入れる必要なし
                    json = JSON.parse(xhr.responseText);
                    // console.log(json);
                    // console.log(json.link_text);

                    // 何もアップロードしないと json = [] で返ってくるため対応
                    if (typeof json.link_text !== "undefined") {
                        // サーバから戻ってきたHTMLをエディタ画面に挿入する。
                        editor.insertContent(json.link_text);
                    }

                    // １画面に複数ウィジウィグがあるプラグイン(blog, database)のために、ここでクリア
                    document.getElementById('cc-face-upload-' + frame_id).value = '';

                    // 閉じる
                    api.close();
                };

                var tokens = document.getElementsByName("csrf-token");
                var page_id = document.getElementsByName("_page_id");
                var data = api.getData();

                // var frame_id = document.getElementsByName("frame_id")[0].value;
                var frame_id = editor.settings.cc_config.frame_id;

                formData = new FormData();
                formData.append('_token', tokens[0].content);
                formData.append('page_id', page_id[0].content);
                formData.append('plugin_name', editor.settings.cc_config.plugin_name);
                // tinymce5で input type fileが無くなったため、wysiwyg.blade.phpに用意した非表示のinput type fileを使って送信
                formData.append('photo', document.getElementById('cc-face-upload-' + frame_id).files[0]);
                formData.append('alt', data.alt);
                formData.append('image_size', data.image_size);
                formData.append('mosaic_fineness', data.mosaic_fineness);

                xhr.send(formData);
            }
        });
    } // function pluginWin()
});
