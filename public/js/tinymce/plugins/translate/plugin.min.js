tinymce.PluginManager.add('translate', function(editor, url) {
    // add: tinymce5対応
    editor.ui.registry.addIcon('translate', '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" width="24" height="24"><!--! Font Awesome Pro 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M448 164C459 164 468 172.1 468 184V188H528C539 188 548 196.1 548 208C548 219 539 228 528 228H526L524.4 232.5C515.5 256.1 501.9 279.1 484.7 297.9C485.6 298.4 486.5 298.1 487.4 299.5L506.3 310.8C515.8 316.5 518.8 328.8 513.1 338.3C507.5 347.8 495.2 350.8 485.7 345.1L466.8 333.8C462.4 331.1 457.1 328.3 453.7 325.3C443.2 332.8 431.8 339.3 419.8 344.7L416.1 346.3C406 350.8 394.2 346.2 389.7 336.1C385.2 326 389.8 314.2 399.9 309.7L403.5 308.1C409.9 305.2 416.1 301.1 422 298.3L409.9 286.1C402 278.3 402 265.7 409.9 257.9C417.7 250 430.3 250 438.1 257.9L452.7 272.4L453.3 272.1C465.7 259.9 475.8 244.7 483.1 227.1H376C364.1 227.1 356 219 356 207.1C356 196.1 364.1 187.1 376 187.1H428V183.1C428 172.1 436.1 163.1 448 163.1L448 164zM160 233.2L179 276H140.1L160 233.2zM0 128C0 92.65 28.65 64 64 64H576C611.3 64 640 92.65 640 128V384C640 419.3 611.3 448 576 448H64C28.65 448 0 419.3 0 384V128zM320 384H576V128H320V384zM178.3 175.9C175.1 168.7 167.9 164 160 164C152.1 164 144.9 168.7 141.7 175.9L77.72 319.9C73.24 329.1 77.78 341.8 87.88 346.3C97.97 350.8 109.8 346.2 114.3 336.1L123.2 315.1H196.8L205.7 336.1C210.2 346.2 222 350.8 232.1 346.3C242.2 341.8 246.8 329.1 242.3 319.9L178.3 175.9z"/></svg>');

    // ウィンドウに入力した値
    var post_contents = '';

    // プラグインボタンの追加
    // change: tinymce5対応 see) https://www.tiny.cloud/docs/advanced/creating-a-plugin/
    // editor.addButton("translate", {
    //     icon: "plugin",
    // 	   image: "/js/tinymce/plugins/translate/translate.svg",
    editor.ui.registry.addButton("translate", {
        icon: "translate",
        tooltip: "翻訳",
        // change: tinymce5対応
        // onclick: pluginWin, // コールバック関数
        onAction: pluginWin,

        onPostRender: function() { // プラグイン要素選択時プラグインボタンアクティブ
            var _this = this;
            editor.on("NodeChange", function(e) {
                //var is_active = jQuery( editor.selection.getNode() ).hasClass("ref");
                var is_active = jQuery( editor.selection.getNode() ).hasClass("plugin");
                _this.active( is_active );
            })

            editor.on("DblClick", function(e) {
                //if ( e.target.className == "plugin" || e.target.className=="ref" ) {
                if ( e.target.className == "plugin" ) {
                    pluginWin(e.toElement.innerText);
                }
            })
        },
    });

    function pluginWin(e) { // プラグインウィンドウを開く関数
        // eはボタンをクリックした場合オブジェクト、プラグインのコンテンツをダブルクリックした際は文字列が入るので判定のため文字列に一旦変換する
        if (String(e).match(/^(&|#)/)) {

            // プラグインの形式に対応する正規表現（暫定）。
            // ややこしいことにインラインテキストのある無しや{}を二重にしたり、改行の有無最後のセミコロンなしでも動くプラグインがあるなど対応が複雑
            var m = e.match(/^(&|#)(\w+)\((.*)\)([\s\S]*)?/);

            if(typeof(m[4]) !== "undefined"){
                if (m[4].match(/;$/)) { m[4] = m[4].replace(/;$/g, "") }; // インライン要素のあるなしにかかわらず行末の;は削除
            }
            //var inline_block_value = (m[1] === "&") ? "inline" : "block";
        } else {
            var m = new Array("", "", "", "", ""); // ボタンをクリックした際は空のデフォルト値を指定
        }

        tinymce.activeEditor.windowManager.open({
            // title: "翻訳（英語に翻訳されます）",
            title: "翻訳",
            width: 600,
            height: 250,
            // change: tinymce5対応
            // body: [{
            // 	type: "textbox",
            // 	name: "inline_text",
            // 	multiline: true,
            // 	minHeight: 220,
            // 	classes : "cc-textarea",
            // 	value : editor.selection.getContent(),
            // 	label: ''
            // }],
            body: {
                type: 'panel',
                items: [
                    {
                        // see) https://www.tiny.cloud/docs/ui-components/dialogcomponents/#textarea
                        type: "textarea",
                        name: "inline_text",
                        label: '',
                        maximized: true // できるだけ多くのスペースを取るために幅を広げます
                    },
                    {
                        type: 'selectbox', // component type
                        name: 'target_language', // identifier
                        label: '翻訳後の言語',
                        size: 1, // number of visible values (optional)
                        items: [
                        { value: 'en', text: '英語' },
                        { value: 'pt', text: 'ポルトガル語' },
                        { value: 'vi', text: 'ベトナム語' },
                        { value: 'fr', text: 'フランス語' },
                        { value: 'de', text: 'ドイツ語' },
                        { value: 'es', text: 'スペイン語' },
                        { value: 'zh', text: '中国語 (簡体字)' },
                        { value: 'zh-TW', text: '中国語 (繁体字)' },
                        { value: 'ko', text: '韓国語' },
                        { value: 'tl', text: 'タガログ語' },
                        ]
                    }
                ]
            },
            buttons: [
                {
                    type: 'cancel',
                    text: 'Close'
                },
                {
                    type: 'submit',
                    text: '翻訳',
                    primary: true
                }
            ],
            initialData: {
                inline_text: editor.selection.getContent()
            },
            // OKボタンをクリックした際の挙動
            // change: tinymce5対応
            // onsubmit: function(e) {
            onSubmit: function(api) {
                //if (e.data.plugin_name === "") { // 入力値のバリデーション（簡易版）
                //	tinyMCE.activeEditor.windowManager.alert("プラグイン名が入力されていません。");
                //	return;
                //}

                // see) https://www.tiny.cloud/docs/ui-components/dialog/#dialogapimethods
                var data = api.getData();

                //alert("XMLHttpRequest");
                xhr = new XMLHttpRequest();
                xhr.withCredentials = false;
                //xhr.open('POST', '/debug/postTest.php');
                // xhr.open('POST', '/api/translate/post');
                xhr.open('POST', tinymce.activeEditor.getParam('document_base_url') + '/api/translate/post');

                xhr.onload = function() {
                    var json;

                    if (xhr.status < 200 || xhr.status >= 300) {
                        // bugfix: 画像アップロード・ハンドラに存在する引数 failure コールバック変数はないため、コンソールのエラー出力に修正
                        // failure('HTTP Error: ' + xhr.status);
                        console.error('HTTP Error: ' + xhr.status);
                        return;
                    }
                    //alert(xhr.status);

                    // console.log(xhr.responseText);
                    json = JSON.parse(xhr.responseText);

                    //alert(xhr.responseText);
                    //alert(json.return_text);

                    //if (!json || typeof json.location != 'string') {
                    //	failure('Invalid JSON: ' + xhr.responseText);
                    //	return;
                    //}

                    //success(json.location);

                    // サーバから戻ってきたHTMLをエディタ画面に挿入する。
                    // console.log(json);
                    // console.log(json.return_texts);

                    for (var i in json.return_texts) {
                        // if (!post_contents) {
                        if (!data.inline_text) {
                            // change: tinymce5対応
                            // tinymce.EditorManager.activeEditor.insertContent('<p>' + json.return_texts[i] + '</p>');
                            editor.insertContent('<p>' + json.return_texts[i] + '</p>');
                        }
                        else {
                            // change: tinymce5対応
                            // tinymce.EditorManager.activeEditor.insertContent('<p>' + post_contents + '<br />' + json.return_texts[i] + '</p>');
                            // editor.insertContent('<p>' + post_contents + '<br />' + json.return_texts[i] + '</p>');
                            editor.insertContent('<p>' + data.inline_text + '<br />' + json.return_texts[i] + '</p>');
                        }
                    }

                    // 閉じる
                    api.close();
                };

                var tokens = document.getElementsByName("csrf-token");
                //alert(tokens[0].content);
                // console.log(api.getData());

                formData = new FormData();
                //formData.append('plugin_name', e.data.plugin_name);
                formData.append('_token', tokens[0].content);

                // TinyMCE が出力するinputタグにnameがないため、classで選択。
                // change: tinymce5対応
                // formData.append('inline_text', jQuery('.mce-cc-textarea').val());
                // formData.append('inline_text', jQuery('.tox-textarea')[0].value);
                formData.append('inline_text', data.inline_text);
                formData.append('target_language', data.target_language);

                // 入力された内容をグローバル変数に保持
                // change: tinymce5対応
                // post_contents = jQuery('.mce-cc-textarea').val();
                // post_contents = jQuery('.tox-textarea')[0].value;

                xhr.send(formData);
            }
        });

        // add: tinymce5対応
        // ダイアログのtextareaにvalueセット
        textarea = jQuery('.tox-textarea')[0];
        // textarea.value = editor.selection.getContent();
        textarea.setAttribute('style', 'min-height: 220px;');

        // console.log(editor.selection.getContent());

    } // function pluginWin()
});
