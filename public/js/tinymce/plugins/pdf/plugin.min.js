tinymce.PluginManager.add('pdf', function(editor, url) {
    // アイコン
    editor.ui.registry.addIcon('pdf', '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" width="24" height="24"><!--! Font Awesome Pro 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M365.3 93.38l-74.63-74.64C278.6 6.742 262.3 0 245.4 0H64C28.65 0 0 28.65 0 64l.0065 384c0 35.34 28.65 64 64 64H320c35.2 0 64-28.8 64-64V138.6C384 121.7 377.3 105.4 365.3 93.38zM336 448c0 8.836-7.164 16-16 16H64.02c-8.838 0-16-7.164-16-16L48 64.13c0-8.836 7.164-16 16-16h160L224 128c0 17.67 14.33 32 32 32h79.1V448zM202 286.1c.877-2.688 1.74-5.398 2.582-8.145c1.434-5.762 7.488-31.54 7.488-52.47C212.1 207 197.1 192 178.6 192C160.1 192 145.1 207 145.1 225.5c0 .2969 .1641 28.81 13.85 62.3c-7.035 19.36-15.57 38.8-25.41 57.93c-21.49 10.11-39.24 22.23-52.8 36.07c-6.234 6.438-9.367 14.74-9.367 24.72c0 18.45 15.01 33.46 33.46 33.46c10.8 0 20.98-5.227 27.22-13.98c7.322-10.28 18.38-26.9 30.47-48.95c15.8-6.352 33.88-11.72 53.88-16c13.55 9.578 28.9 17.29 45.71 22.95c4.527 1.551 9.402 2.348 14.43 2.348c20.26 0 36.13-16.19 36.13-36.86c0-20.33-16.54-36.87-36.87-36.87h-3.705c-2.727 .125-20.51 1.141-45.37 5.367C216.9 308.9 208.6 298.3 202 286.1zM110.2 410.4c-3.273 4.688-12.03 2.777-12.03-5.312c0-1.754 .6289-3.43 1.729-4.555c9.02-9.219 19.94-17.05 31.85-23.72C122.3 393.1 114.3 404.7 110.2 410.4zM178.6 218.8c3.693 0 6.703 3.008 6.703 6.703c0 15.21-4.109 34.84-5.746 42.1C172.1 245 171.9 227.2 171.9 225.5C171.9 221.8 174.9 218.8 178.6 218.8zM162.3 348.3c6.611-13.48 13.22-28.46 19.38-44.7c6.389 10.92 14.56 21.86 24.96 31.97C192.6 338.8 177.4 342.9 162.3 348.3zM272.4 339.5h3.352c5.539 0 10.05 4.5 10.05 10.79c0 5.129-4.176 9.32-9.32 9.32c-2.029 0-4.059-.3164-5.852-.9414c-12.33-4.137-23.11-9.32-32.54-15.19C258.3 340.3 272.1 339.5 272.4 339.5z"/></svg>');

    // プラグインボタンの追加
    // see) https://www.tiny.cloud/docs/advanced/creating-a-plugin/
    editor.ui.registry.addButton("pdf", {
        icon: "pdf",
        tooltip: "PDFアップロード",
        onAction: pluginWin,

        onPostRender: function() { // プラグイン要素選択時プラグインボタンアクティブ
            var _this = this;
            editor.on("NodeChange", function(e) {
                var is_active = jQuery( editor.selection.getNode() ).hasClass("plugin");
                _this.active( is_active );
            })

            editor.on("DblClick", function(e) {
                if ( e.target.className == "plugin" ) {
                    pluginWin(e.toElement.innerText);
                }
            })
        },
    });

    function pluginWin(e) { // プラグインウィンドウを開く関数
        tinymce.activeEditor.windowManager.open({
            title: "PDFアップロード",
            body: {
                type: 'panel',
                items: [
                    {
                        // see) https://www.tiny.cloud/docs/ui-components/dialogcomponents/#alertbanner
                        type: 'alertbanner',
                        level: 'info',
                        text: 'PDFからサムネイル画像を自動作成します。',
                        icon: 'info',
                    },
                    {
                        // see) https://www.tiny.cloud/docs/ui-components/dialogcomponents/#urlinput
                        type: "urlinput",
                        name: "pdf",
                        filetype: 'file', // allow any file types
                        label: 'PDF'
                    },
                    // アップロードできる最大サイズのキャプション
                    {
                        type: 'collection',
                        name: 'upload_max_filesize_caption', // identifier
                        label: editor.settings.cc_config.upload_max_filesize_caption
                    },
                    {
                        type: 'listbox',
                        name: 'width_of_pdf_thumbnails', // identifier
                        label: 'サムネイルの大きさ',
                        disabled: false,
                        items: editor.settings.cc_config.width_of_pdf_thumbnails_items,
                    },
                    {
                        // see) https://www.tiny.cloud/docs/ui-components/dialogcomponents/#listbox
                        type: 'listbox',
                        name: 'number_of_pdf_thumbnails', // identifier
                        label: 'サムネイルの数',
                        disabled: false,
                        items: editor.settings.cc_config.number_of_pdf_thumbnails_items,
                    },
                    {
                        // see) https://www.tiny.cloud/docs/ui-components/dialogcomponents/#input
                        type: 'input',
                        name: 'pdf_password',
                        inputMode: 'text',
                        label: 'PDFパスワード',
                        placeholder: '',
                        disabled: false,
                        maximized: false
                    },
                    {
                        type: 'collection',
                        name: 'pdf_password_caption', // identifier
                        label: '※ パスワード付PDFの場合、入力してください。'
                    }
                ]
            },
            // 初期値設定
            initialData: {
                width_of_pdf_thumbnails: editor.settings.cc_config.width_of_pdf_thumbnails_initial,
                number_of_pdf_thumbnails: editor.settings.cc_config.number_of_pdf_thumbnails_initial,
            },
            buttons: [
                {
                    type: 'cancel',
                    text: 'Close'
                },
                {
                    type: 'submit',
                    text: 'Save',
                    primary: true
                }
            ],
            // OKボタンをクリックした際の挙動
            onSubmit: function(api) {
                // AJAX
                xhr = new XMLHttpRequest();
                xhr.withCredentials = false;
                xhr.open('POST', tinymce.activeEditor.getParam('document_base_url') + '/upload');

                xhr.onload = function() {
                    var json;

                    if (xhr.status < 200 || xhr.status >= 300) {
                        // コンソールのエラー出力
                        console.error('HTTP Error: ' + xhr.status);
                        return;
                    }

                    // jsonエラーは、JSON.parse()で発生するため、特別処理を入れる必要なし
                    json = JSON.parse(xhr.responseText);
                    // console.log(json);
                    // console.log(json.link_text);

                    // 何もアップロードしないと json = [] で返ってくるため対応
                    if (typeof json.link_text !== "undefined") {
                        // サーバから戻ってきたHTMLをエディタ画面に挿入する。
                        editor.insertContent(json.link_text);
                    }

                    // １画面に複数ウィジウィグがあるプラグイン(blog, database)のために、ここでクリア
                    document.getElementById('cc-pdf-upload-' + frame_id).value = '';

                    // 閉じる
                    api.close();
                };

                var tokens = document.getElementsByName("csrf-token");
                var page_id = document.getElementsByName("_page_id");
                var data = api.getData();

                // var frame_id = document.getElementsByName("frame_id")[0].value;
                var frame_id = editor.settings.cc_config.frame_id;

                formData = new FormData();
                formData.append('_token', tokens[0].content);
                formData.append('page_id', page_id[0].content);
                formData.append('plugin_name', editor.settings.cc_config.plugin_name);
                // tinymce5で input type fileが無くなったため、wysiwyg.blade.phpに用意した非表示のinput type fileを使って送信
                formData.append('pdf', document.getElementById('cc-pdf-upload-' + frame_id).files[0]);
                formData.append('pdf_password', data.pdf_password);
                formData.append('width_of_pdf_thumbnails', data.width_of_pdf_thumbnails);
                formData.append('number_of_pdf_thumbnails', data.number_of_pdf_thumbnails);

                // console.log(document.getElementById('cc-pdf-upload-' + frame_id).files.length);

                xhr.send(formData);
            }
        });
    } // function pluginWin()
});
