tinymce.PluginManager.add('file', function(editor, url) {
    // add: tinymce5対応
    editor.ui.registry.addIcon('file', '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="20" height="20"><!--! Font Awesome Pro 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M364.2 83.8C339.8 59.39 300.2 59.39 275.8 83.8L91.8 267.8C49.71 309.9 49.71 378.1 91.8 420.2C133.9 462.3 202.1 462.3 244.2 420.2L396.2 268.2C407.1 257.3 424.9 257.3 435.8 268.2C446.7 279.1 446.7 296.9 435.8 307.8L283.8 459.8C219.8 523.8 116.2 523.8 52.2 459.8C-11.75 395.8-11.75 292.2 52.2 228.2L236.2 44.2C282.5-2.08 357.5-2.08 403.8 44.2C450.1 90.48 450.1 165.5 403.8 211.8L227.8 387.8C199.2 416.4 152.8 416.4 124.2 387.8C95.59 359.2 95.59 312.8 124.2 284.2L268.2 140.2C279.1 129.3 296.9 129.3 307.8 140.2C318.7 151.1 318.7 168.9 307.8 179.8L163.8 323.8C157.1 330.5 157.1 341.5 163.8 348.2C170.5 354.9 181.5 354.9 188.2 348.2L364.2 172.2C388.6 147.8 388.6 108.2 364.2 83.8V83.8z"/></svg>');

    // プラグインボタンの追加
    // change: tinymce5対応 see) https://www.tiny.cloud/docs/advanced/creating-a-plugin/
    // editor.addButton("file", {
    editor.ui.registry.addButton("file", {
        icon: "file",
        // delete: tinymce5対応
        // image: tinyMCE.baseURL + "/plugins/file/plugin.png",
        tooltip: "ファイルアップロード",
        // change: tinymce5対応
        // onclick: pluginWin, // コールバック関数
        onAction: pluginWin,

        onPostRender: function() { // プラグイン要素選択時プラグインボタンアクティブ
            var _this = this;
            editor.on("NodeChange", function(e) {
                //var is_active = jQuery( editor.selection.getNode() ).hasClass("ref");
                var is_active = jQuery( editor.selection.getNode() ).hasClass("plugin");
                _this.active( is_active );
            })

            editor.on("DblClick", function(e) {
                //if ( e.target.className == "plugin" || e.target.className=="ref" ) {
                if ( e.target.className == "plugin" ) {
                    pluginWin(e.toElement.innerText);
                }
            })
        },
    });

    function pluginWin(e) { // プラグインウィンドウを開く関数
        // eはボタンをクリックした場合オブジェクト、プラグインのコンテンツをダブルクリックした際は文字列が入るので判定のため文字列に一旦変換する
        if (String(e).match(/^(&|#)/)) {

            // プラグインの形式に対応する正規表現（暫定）。
            // ややこしいことにインラインテキストのある無しや{}を二重にしたり、改行の有無最後のセミコロンなしでも動くプラグインがあるなど対応が複雑
            var m = e.match(/^(&|#)(\w+)\((.*)\)([\s\S]*)?/);

            if(typeof(m[4]) !== "undefined"){
                if (m[4].match(/;$/)) { m[4] = m[4].replace(/;$/g, "") }; // インライン要素のあるなしにかかわらず行末の;は削除
            }
            //var inline_block_value = (m[1] === "&") ? "inline" : "block";
        } else {
            var m = new Array("", "", "", "", ""); // ボタンをクリックした際は空のデフォルト値を指定
        }
        tinymce.activeEditor.windowManager.open({
            title: "ファイルアップロード",
            width: 600,
            height: 250,
            // change: tinymce5対応
            // body: [{
            // 	type: "textbox",
            // 	name: "file1",
            // 	classes : "cc-file-upload",
            // 	subtype: "file",
            // 	filetype: 'file', // allow any file types
            // 	label: 'ファイル1'
            // },{
            // 	type: "textbox",
            // 	name: "file2",
            // 	classes : "cc-file-upload",
            // 	subtype: "file",
            // 	filetype: 'file', // allow any file types
            // 	label: 'ファイル2'
            // },{
            // 	type: "textbox",
            // 	name: "file3",
            // 	classes : "cc-file-upload",
            // 	subtype: "file",
            // 	filetype: 'file', // allow any file types
            // 	label: 'ファイル3'
            // },{
            // 	type: "textbox",
            // 	name: "file4",
            // 	classes : "cc-file-upload",
            // 	subtype: "file",
            // 	filetype: 'file', // allow any file types
            // 	label: 'ファイル4'
            // },{
            // 	type: "textbox",
            // 	name: "file5",
            // 	classes : "cc-file-upload",
            // 	subtype: "file",
            // 	filetype: 'file', // allow any file types
            // 	label: 'ファイル5'
            // }],
            body: {
                type: 'panel',
                items: [
                    {
                        // see) https://www.tiny.cloud/docs/ui-components/dialogcomponents/#urlinput
                        type: "urlinput",
                        name: "file1",
                        filetype: 'file', // allow any file types
                        label: 'ファイル1'
                    },{
                        type: "urlinput",
                        name: "file2",
                        filetype: 'file', // allow any file types
                        label: 'ファイル2'
                    },{
                        type: "urlinput",
                        name: "file3",
                        filetype: 'file', // allow any file types
                        label: 'ファイル3'
                    },{
                        type: "urlinput",
                        name: "file4",
                        filetype: 'file', // allow any file types
                        label: 'ファイル4'
                    },{
                        type: "urlinput",
                        name: "file5",
                        filetype: 'file', // allow any file types
                        label: 'ファイル5'
                    },
                    // アップロードできる最大サイズのキャプション
                    {
                        type: 'collection', // component type
                        name: 'upload_max_filesize_caption', // identifier
                        label: editor.settings.cc_config.upload_max_filesize_caption
                    }
                ]
            },
            buttons: [
                {
                    type: 'cancel',
                    text: 'Close'
                },
                {
                    type: 'submit',
                    text: 'Save',
                    primary: true
                }
            ],
            // OKボタンをクリックした際の挙動
            // change: tinymce5対応
            // onSubmit: function(e) {
            onSubmit: function(api) {
                //if (e.data.plugin_name === "") { // 入力値のバリデーション（簡易版）
                //	tinyMCE.activeEditor.windowManager.alert("プラグイン名が入力されていません。");
                //	return;
                //}

                // var data = api.getData();
                /* Insert content when the window form is submitted */
                // editor.insertContent('Title: ' + data.title);

                // AJAX
                //alert("XMLHttpRequest");
                xhr = new XMLHttpRequest();
                xhr.withCredentials = false;
                //xhr.open('POST', '/debug/postTest.php');
                // change: tinymce5対応
                // xhr.open('POST', tinymce.activeEditor.getParam('base_url') + '/upload');
                xhr.open('POST', tinymce.activeEditor.getParam('document_base_url') + '/upload');
                // console.log(tinymce.activeEditor.getParam('document_base_url') );

                xhr.onload = function() {
                    var json;

                    if (xhr.status < 200 || xhr.status >= 300) {
                        // bugfix: 画像アップロード・ハンドラに存在する引数 failure コールバック変数はないため、コンソールのエラー出力に修正
                        // failure('HTTP Error: ' + xhr.status);
                        console.error('HTTP Error: ' + xhr.status);
                        return;
                    }
                    //alert(xhr.status);

                    json = JSON.parse(xhr.responseText);

                    //alert(xhr.responseText);
                    //alert(json.return_text);

                    //if (!json || typeof json.location != 'string') {
                    //	failure('Invalid JSON: ' + xhr.responseText);
                    //	return;
                    //}

                    //success(json.location);

                    // サーバから戻ってきたHTMLをエディタ画面に挿入する。
                    // console.log(json);
                    // console.log(json.link_texts);
                    for (var i in json.link_texts) {
                        // change: tinymce5対応
                        // tinymce.EditorManager.activeEditor.insertContent(json.link_texts[i]);
                        editor.insertContent(json.link_texts[i]);
                    }

                    // bugfix: １画面に複数ウィジウィグがあるプラグイン(blog, database)のために、ここでクリア
                    document.getElementById('cc-file-upload-file1-' + frame_id).value = '';
                    document.getElementById('cc-file-upload-file2-' + frame_id).value = '';
                    document.getElementById('cc-file-upload-file3-' + frame_id).value = '';
                    document.getElementById('cc-file-upload-file4-' + frame_id).value = '';
                    document.getElementById('cc-file-upload-file5-' + frame_id).value = '';

                    // 閉じる
                    api.close();
                };

                //alert(e.data.file1);
                //console.log(jQuery('.mce-cc-file-upload'));
                //return;

                var tokens = document.getElementsByName("csrf-token");
                //alert(tokens[0].content);
                var page_id = document.getElementsByName("_page_id");

                formData = new FormData();
                //formData.append('plugin_name', e.data.plugin_name);
                formData.append('_token', tokens[0].content);
                formData.append('page_id', page_id[0].content);
                formData.append('plugin_name', editor.settings.cc_config.plugin_name);

                // change: tinymce5対応
                // TinyMCE が出力するinputタグにnameがないため、classで選択。classesでの指定はcc-file-uploadだが、TinyMCE が mce- を付けて出力する。
                // formData.append('file1', jQuery('.mce-cc-file-upload')[0].files[0]);
                // formData.append('file2', jQuery('.mce-cc-file-upload')[1].files[0]);
                // formData.append('file3', jQuery('.mce-cc-file-upload')[2].files[0]);
                // formData.append('file4', jQuery('.mce-cc-file-upload')[3].files[0]);
                // formData.append('file5', jQuery('.mce-cc-file-upload')[4].files[0]);

                // type で指定する方法。画面上に他にinput type=file がいるとおかしくなると思うので、classでのセレクタにした。
                //formData.append('file1', jQuery('input[type=file]')[0].files[0]);

                // tinymce5で input type fileが無くなったため、wysiwyg.blade.phpに用意した非表示のinput type fileを使って送信
                // var frame_id = document.getElementsByName("frame_id")[0].value;
                var frame_id = editor.settings.cc_config.frame_id;

                // console.log(frame_id[0].value);
                formData.append('file1', document.getElementById('cc-file-upload-file1-' + frame_id).files[0]);
                formData.append('file2', document.getElementById('cc-file-upload-file2-' + frame_id).files[0]);
                formData.append('file3', document.getElementById('cc-file-upload-file3-' + frame_id).files[0]);
                formData.append('file4', document.getElementById('cc-file-upload-file4-' + frame_id).files[0]);
                formData.append('file5', document.getElementById('cc-file-upload-file5-' + frame_id).files[0]);

                xhr.send(formData);

                //if (e.data.inline_block === "inline") { var inline_block = ["&", ";"] } else { var inline_block = ["#", ""] }
                //if (e.data.inline_text) { var inline_text = e.data.inline_text; inline_text = inline_text.replace(/\r?\n/g, "<br>"); } else { var inline_text = ""}
                //editor.insertContent( '<span class="plugin" contenteditable="false" style="cursor: default;" data-mce-style="cursor: default;">' + 'テスト' + '(' + e.data.plugin_option + ')' + inline_text + '</span>');
            }
        });
    } // function pluginWin()
});
