tinymce.PluginManager.add('file', function(editor, url) {
	editor.addButton("file", { // プラグインボタンの追加
		icon: "plugin",
		image: tinyMCE.baseURL + "/plugins/file/plugin.png",
		tooltip: "ファイルアップロード",
		onclick: pluginWin, // コールバック関数

		onPostRender: function() { // プラグイン要素選択時プラグインボタンアクティブ
			var _this = this;
			editor.on("NodeChange", function(e) {
				//var is_active = jQuery( editor.selection.getNode() ).hasClass("ref");
				var is_active = jQuery( editor.selection.getNode() ).hasClass("plugin");
				_this.active( is_active );
			})
 
			editor.on("DblClick", function(e) {
				//if ( e.target.className == "plugin" || e.target.className=="ref" ) {
				if ( e.target.className == "plugin" ) {
					pluginWin(e.toElement.innerText);
				}
			})
		},
	});

	function pluginWin(e) { // プラグインウィンドウを開く関数
		// eはボタンをクリックした場合オブジェクト、プラグインのコンテンツをダブルクリックした際は文字列が入るので判定のため文字列に一旦変換する
		if (String(e).match(/^(&|#)/)) {

			// プラグインの形式に対応する正規表現（暫定）。
			// ややこしいことにインラインテキストのある無しや{}を二重にしたり、改行の有無最後のセミコロンなしでも動くプラグインがあるなど対応が複雑
			var m = e.match(/^(&|#)(\w+)\((.*)\)([\s\S]*)?/);

			if(typeof(m[4]) !== "undefined"){
				if (m[4].match(/;$/)) { m[4] = m[4].replace(/;$/g, "") }; // インライン要素のあるなしにかかわらず行末の;は削除
			}
			//var inline_block_value = (m[1] === "&") ? "inline" : "block";
		} else {
			var m = new Array("", "", "", "", ""); // ボタンをクリックした際は空のデフォルト値を指定
		}
		tinymce.activeEditor.windowManager.open({
			title: "ファイルアップロード",
			width: 600,
			height: 250,
			body: [{
				type: "textbox",
				name: "file1",
				classes : "cc-file-upload",
				subtype: "file",
				filetype: 'file', // allow any file types
				label: 'ファイル1'
			},{
				type: "textbox",
				name: "file2",
				classes : "cc-file-upload",
				subtype: "file",
				filetype: 'file', // allow any file types
				label: 'ファイル2'
			},{
				type: "textbox",
				name: "file3",
				classes : "cc-file-upload",
				subtype: "file",
				filetype: 'file', // allow any file types
				label: 'ファイル3'
			},{
				type: "textbox",
				name: "file4",
				classes : "cc-file-upload",
				subtype: "file",
				filetype: 'file', // allow any file types
				label: 'ファイル4'
			},{
				type: "textbox",
				name: "file5",
				classes : "cc-file-upload",
				subtype: "file",
				filetype: 'file', // allow any file types
				label: 'ファイル5'
			}],

			onsubmit: function(e) { // OKボタンをクリックした際の挙動
				//if (e.data.plugin_name === "") { // 入力値のバリデーション（簡易版）
				//	tinyMCE.activeEditor.windowManager.alert("プラグイン名が入力されていません。");
				//	return;
				//}

				//alert("XMLHttpRequest");
				xhr = new XMLHttpRequest();
				xhr.withCredentials = false;
				//xhr.open('POST', '/debug/postTest.php');
				xhr.open('POST', tinymce.activeEditor.getParam('base_url') + '/upload');

				xhr.onload = function() {
					var json;

					if (xhr.status < 200 || xhr.status >= 300) {
						failure('HTTP Error: ' + xhr.status);
						return;
					}
					//alert(xhr.status);

					json = JSON.parse(xhr.responseText);

					//alert(xhr.responseText);
					//alert(json.return_text);

					//if (!json || typeof json.location != 'string') {
					//	failure('Invalid JSON: ' + xhr.responseText);
					//	return;
					//}

					//success(json.location);

					// サーバから戻ってきたHTMLをエディタ画面に挿入する。
					// console.log(json);
					// console.log(json.link_texts);
					for (var i in json.link_texts) {
						tinymce.EditorManager.activeEditor.insertContent(json.link_texts[i]);
					}
				};

				//alert(e.data.file1);
				//console.log(jQuery('.mce-cc-file-upload'));
				//return;

				var tokens = document.getElementsByName("csrf-token");
				//alert(tokens[0].content);
				var page_id = document.getElementsByName("_page_id");

				formData = new FormData();
				//formData.append('plugin_name', e.data.plugin_name);
				formData.append('_token', tokens[0].content);
				formData.append('page_id', page_id[0].content);

				// TinyMCE が出力するinputタグにnameがないため、classで選択。classesでの指定はcc-file-uploadだが、TinyMCE が mce- を付けて出力する。
				formData.append('file1', jQuery('.mce-cc-file-upload')[0].files[0]);
				formData.append('file2', jQuery('.mce-cc-file-upload')[1].files[0]);
				formData.append('file3', jQuery('.mce-cc-file-upload')[2].files[0]);
				formData.append('file4', jQuery('.mce-cc-file-upload')[3].files[0]);
				formData.append('file5', jQuery('.mce-cc-file-upload')[4].files[0]);

				// type で指定する方法。画面上に他にinput type=file がいるとおかしくなると思うので、classでのセレクタにした。
				//formData.append('file1', jQuery('input[type=file]')[0].files[0]);

				xhr.send(formData);

				//if (e.data.inline_block === "inline") { var inline_block = ["&", ";"] } else { var inline_block = ["#", ""] }
				//if (e.data.inline_text) { var inline_text = e.data.inline_text; inline_text = inline_text.replace(/\r?\n/g, "<br>"); } else { var inline_text = ""}
				//editor.insertContent( '<span class="plugin" contenteditable="false" style="cursor: default;" data-mce-style="cursor: default;">' + 'テスト' + '(' + e.data.plugin_option + ')' + inline_text + '</span>');
			}
		});
	} // function pluginWin()
});
